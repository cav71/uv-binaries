name: Main-build

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

env:
  PACKAGE: ${{ github.event.repository.name }}
  PYTHONPATH: src
  GITHUB_DUMP_FULL: ${{ toJson(github) }}
  GITHUB_DUMP: |
    {
      "version":    "v1", 
      "name":       "${{ github.event.repository.name }}",
      "ref":        "${{ github.ref }}", 
      "sha":        "${{ github.sha }}", 
      "run_number": "${{ github.run_number }}"
    }
  TARGETPY: "3.13"
  TARGETOS: "ubuntu-latest"

jobs:
  betas:
    container:
      image: cavallo71/uv-builder
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.os }}

    steps:
      # https://github.com/actions/checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # WARNING!! this is important
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Dump ENV
        shell: bash
        run: |
          echo "=== GITHUB_DUMP ==="
          echo "$GITHUB_DUMP_FULL" 
          echo "=== END GITHUB_DUMP ==="
          echo "uname: $(uname -a)"
          echo "python: $(python3 -V)"

      - name: Runtime info
        shell: bash
        run: python3 /usr/bin/info.pyz


      - name: Build binaries
        shell: bash
        run: ./build.sh binaries
#       - name: Archive artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: qa-results-${{ matrix.python-version }}-${{ matrix.os }}
#           path: |
#             build/qa-${{ matrix.python-version }}-${{ matrix.os}}
#             dist
#             .keepme
#         # Use always() to always run this step to publish test results when there are test failures
#         if: always()
